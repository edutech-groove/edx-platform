## mako
<%page expression_filter="h"/>

<%inherit file="/main.html" />
<%!
from datetime import datetime

from django.urls import reverse
from django.utils.translation import ugettext as _
from mako import exceptions
from courseware.courses import get_course_about_section
import json

from openedx.core.djangolib.markup import HTML, Text
%>
<%namespace name='static' file='../static_content.html'/>

## Override the default styles_version to use Bootstrap
<%! main_css = "css/lms-program-about.css" %>


<%
video_url = program['video'].get('src') if program['video'] else ''
faqs = program['faq']
program_type = program['type'] if program['type'] else 'Program'
title = program['title']
courses = program['courses']
total_hours_of_effort = program['total_hours_of_effort']
subtitle = program['subtitle']
overview = program['overview']
instructors = program['instructor_ordering']
job_outlook_items = program['job_outlook_items']
weeks_to_complete = program['weeks_to_complete']
full_program_price_format = '{0:.0f}' if program['full_program_price'].is_integer() else '{0:.2f}'
full_program_price = full_program_price_format.format(program['full_program_price'])
expected_learning_items = program['expected_learning_items']
min_hours_effort_per_week = program['min_hours_effort_per_week']
max_hours_effort_per_week = program['max_hours_effort_per_week']
authoring_organizations = program['authoring_organizations']
%>

<%def name="get_courserun_efforts(course_run)">
  % if course_run['min_effort'] is None and course_run['max_effort'] is not None:
    ${course_run['max_effort']} hours per weeks
  % elif course_run['min_effort'] is not None and course_run['max_effort'] is None:
    ${course_run['min_effort']} hours per weeks
  % elif course_run['min_effort'] is not None and course_run['max_effort'] is not None:
    ${course_run['min_effort']}-${course_run['max_effort']} hours per weeks  
  % endif

  % if course_run['weeks_to_complete'] is not None:
, for ${course_run['weeks_to_complete']} weeks
  % endif
</%def>

<%block name="js_extra">
  <script src="${static.url('js/leanModal.js')}"></script>
  <script src="${static.url('js/program_marketing.js')}"></script>
</%block>

<%block name="pagetitle">${program['title']}</%block>
<%block name="marketing_hero">
  <%
    banner_image = program.get('banner_image', {}).get('large', {}).get('url', '')
    authoring_organizations = program['authoring_organizations']
    faqs = program['faq']
    courses = program['courses']
    instructors = program['instructor_ordering']
    full_program_price_format = '{0:.0f}' if program['full_program_price'].is_integer() else '{0:.2f}'
    full_program_price = full_program_price_format.format(program['full_program_price'])
  %>
  <div id="program-details-hero">
    <div class="main-banner"
      style="background: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7) ), url(${banner_image});">
      <div class="container">
        <div class="subtitle">
          <h2>${program['subtitle']}</h2>
        </div>
      </div>
    </div>
    <div class="sub-banner">
      <div class="row">
        <div class="col-4">
          <div class="org-logo">
            % if len(authoring_organizations) and authoring_organizations[0]['logo_image_url']:
              <img class="authoring-org-logo" alt="${authoring_organizations[0]['name']}" src="${authoring_organizations[0]['logo_image_url']}" onerror="onImgError(this);"/>
            % else:
              <img class="authoring-org-logo" src="" onerror="onImgError(this);"/>
            % endif
          </div>
        </div>
        <div class="col-4">
          <h1 class="program_title">
            ${program['type']} in <br/>
            ${program['title']}
          </h1>
        </div>
        <div class="col-4">
          <a class="btn-interest ${'disabled' if not program.get('is_learner_eligible_for_one_click_purchase') else ''}" ${'disabled' if not program.get('is_learner_eligible_for_one_click_purchase') else 'href="#purchasing"'} >
            <div class="btn-content">
              ${_('I\'m interested')} 
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20">
                <use xlink:href="#${'gray-checkmark' if not program.get('is_learner_eligible_for_one_click_purchase') else 'checkmark'}"></use>
              </svg>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</%block>

<div id="program-details-page">
  <div class="container">
    <div class="row program-info">
      <div class="col col-12 col-lg-8">
        <div class="section what-you-will-learn">
          % if expected_learning_items or overview:
            <div class="section-title">
              <h3>
                ${_('What you will learn')}
              </h3>
            </div>
            <div class="section-content">
              % if expected_learning_items:
              <ul>
                % for item in expected_learning_items:
                  <li>${item}</li>
                % endfor
                % if video_url:
                <li class="program_video">
                  <div id="program_video">
                    <button type="button" class="btn-play-video" aria-label="${_('Play')}" onclick="playVideo('${video_url}')">
                      <div class="btn-content">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36">
                          <g transform="translate(-130 -828)">
                            <circle fill="#fff" opacity="0.2" cx="18" cy="18" r="18" transform="translate(130 828)"/>
                            <path fill="#fff" d="M11.6,5.872,1.98.182A1.305,1.305,0,0,0,0,1.311V12.688a1.311,1.311,0,0,0,1.98,1.129L11.6,8.13A1.311,1.311,0,0,0,11.6,5.872Z" transform="translate(143 838.998)"/>
                          </g>
                        </svg>
                        Play Video
                      </div>
                    </button>
                    <div id="embed-video" style="display: none;">
                      <iframe width="100%" height="100%" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                  </div>
                </li>
                % endif
              </ul>
              % endif
    
              %if overview:
              <div class="program-overview">
                <div class="accordion acc-lg">
                  <div class="header">
                    <span class="title">Program Overview</span>
                    <svg width="14" height="14" class="status-icon">
                      <use xlink:href="#plus"></use>
                    </svg>
                  </div>
                  <div class="body" style="display: none;">
                    ${HTML(overview)}
                  </div>
                </div>
              </div>
              %endif
            </div>
          %endif
        </div>
        % if courses or job_outlook_items:
        <div class="section courses-in-program">
          <div class="section-title">
            <h3>
              ${_('Courses in the {}').format(
                program_type
              )}
            </h3>
          </div>
          <div class="section-content">

            <div class="courses-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18.281" height="24">
                <use xlink:href="#marker"></use>
              </svg>
              % if len(authoring_organizations) and authoring_organizations[0]['name']:
              ${authoring_organizations[0]['name']}'s ${program['title']} ${program['type']}
              % endif
            </div>

            <div class="courses-content">
              % if courses:
              <div class="accordions-wrapper">
                % for course in courses:
                  <%
                    ## The goal here is to get the `oldest course run that still has open enrollment`.
                    ## We fall back on the newest course if none are available for enrollment.
                    sorted_course_runs = sorted(course['course_runs'], key=lambda run: run['start'])
                    open_course_runs = [run for run in sorted_course_runs if run['is_enrollment_open']]
                    course_run = open_course_runs[0] if open_course_runs else sorted_course_runs[-1]
                    course_img = course_run.get('image')
                    course_about_url = reverse('about_course', args=[course_run['key']])
                    course_purchase_url = course_run['upgrade_url'] if course_run['upgrade_url'] else course_about_url
                    course_start_date = course_run['enrollment_start'] or course_run['start']
                    course_end_date = course_run['enrollment_end'] or course_run['end']
                  %>
                  
                  <div class="accordion has-icon course-item">
                    <div class="header">
                      <svg width="15.75" height="18" class="icon">
                        <use xlink:href="#book"></use>
                      </svg>
                      <span class="title">${course_run['title']}</span>
                      <svg width="14" height="14" class="status-icon">
                        <use xlink:href="#plus"></use>
                      </svg>
                    </div>
                    <div class="body" style="display: none;">
                      <ul>
                        % if not course_run['is_course_ended'] and course_start_date:
                        <li>
                          <div class="icon-content">
                            <svg width="16" height="16">
                              <use xlink:href="#calendar"></use>
                            </svg>
                            <%
                              course_date_string = datetime.strptime(course_start_date,"%Y-%m-%dT%H:%M:%SZ")
                            %>
                            <span>
                              Starts <span class="important-dates-item-text start-date localized_datetime" data-format="shortDate" data-datetime="${course_date_string}" data-language="${LANGUAGE_CODE}"></span>
                            </span>
                          </div>
                        </li>
                        % endif
                        <%
                        courserun_efforts = get_courserun_efforts(course_run)
                        %>
                        % if courserun_efforts:
                        <li>
                          <div class="icon-content">
                            <svg width="16" height="16">
                              <use xlink:href="#clock-solid"></use>
                            </svg>
                            ${courserun_efforts}
                          </div>
                        </li>
                        % endif
                        % if course_run['short_description']:
                        <li>
                          ${course_run['short_description']}
                        </li>
                        % endif
                        <li>
                          <a class="view-course-btn" href="${course_about_url}">
                            <div class="btn-content">
                              ${_('View the course')} 
                              <svg xmlns="http://www.w3.org/2000/svg" width="8.348" height="8" viewBox="0 0 8.348 8">
                                <g transform="translate(-1038 -508)">
                                  <path d="M14.442,10.195,11.414,7.17a.569.569,0,0,1,0-.807.577.577,0,0,1,.81,0l3.43,3.427a.571.571,0,0,1,.017.788L12.227,14.03a.572.572,0,0,1-.81-.807Z" transform="translate(1026.753 501.804)"/>
                                  <path d="M14.442,10.195,11.414,7.17a.569.569,0,0,1,0-.807.577.577,0,0,1,.81,0l3.43,3.427a.571.571,0,0,1,.017.788L12.227,14.03a.572.572,0,0,1-.81-.807Z" transform="translate(1030.527 501.804)"/>
                                </g>
                              </svg>
                            </div>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                % endfor
              </div>
              % endif
              % if job_outlook_items:
              <div class="accordions-wrapper">
                <div class="accordion has-icon course-item">
                  <div class="header">
                    <svg width="18" height="18" class="icon">
                      <use xlink:href="#compass"></use>
                    </svg>
                    <span class="title">${_('Job Outlook')}</span>
                    <svg width="14" height="14" class="status-icon">
                      <use xlink:href="#plus"></use>
                    </svg>
                  </div>
                  <div class="body" style="display: none;">
                    <ul>
                      % for item in job_outlook_items:
                        <li>${item}</li>
                      % endfor
                    </ul>
                  </div>
                </div>
              </div>
              % endif
            </div>
          </div>
        </div>
        % endif
      </div>
      <div class="col col-12 col-lg-4">
        <div class="facts" id="facts">
          <ul class="list-unstyled">
            <li>
              <div class="icon">
                <svg>
                  <use xlink:href="#clock-solid"></use>
                </svg>
              </div>
              <div class="text">
                <div class="label">${_('Average Length')}</div>
                <div class="value">
                  ${Text(_('{weeks_to_complete} weeks per course')).format(
                    weeks_to_complete=weeks_to_complete
                  )}
                </div>
              </div>
            </li>
            <li>
              <div class="icon">
                <svg>
                  <use xlink:href="#tachometer"></use>
                </svg>
              </div>
              <div class="text">
                <div class="label">${_('Effort')}</div>
                <div class="value">
                  ${Text(_('{min_hours_effort_per_week}-{max_hours_effort_per_week} hours per week, per course')).format(
                    max_hours_effort_per_week=max_hours_effort_per_week,
                    min_hours_effort_per_week=min_hours_effort_per_week
                  )}
                </div>
              </div>
            </li>
            <li>
              <div class="icon">
                <svg>
                  <use xlink:href="#book"></use>
                </svg>
              </div>
              <div class="text">
                <div class="label">${_('Number of Courses')}</div>
                <div class="value">
                  ${Text(_('{number_of_courses} courses in program')).format(
                    number_of_courses=len(courses)
                  )}
                </div>
              </div>
            </li>
            <li>
              <div class="icon">
                <svg class="small">
                  <use xlink:href="#money"></use>
                </svg>
              </div>
              <div class="text">
                <div class="label">${_('Price (USD)')}</div>
                <div class="value">
                  % if program.get('discount_data') and program['discount_data']['is_discounted']:
                    <span class="price">
                      <span aria-label="${_('Discounted Price')}" class="discount">
                        ${Text(_('${newPrice}')).format(
                          newPrice=full_program_price
                        )}
                      </span>
                      <del aria-label="${_('Original Price')}" class="original-price">
                        ${Text(_('${oldPrice}')).format(
                          oldPrice=full_program_price_format.format(program['discount_data']['total_incl_tax_excl_discounts'])
                        )}
                      </del><br/>
                      for entire program
                    </span>
                  % else:
                    <span>
                      ${Text(_('${full_program_price} for entire program')).format(
                        full_program_price=full_program_price
                      )}
                    </span>
                  % endif
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  % if instructors:
  <div class="instructors-wrapper" id="instructor">
    <div class="container">
      <div class="section instructors">
        % if len(authoring_organizations) and authoring_organizations[0]['key']:
        <div class="text-callout">
          Experts from ${authoring_organizations[0]['key']} committed to teaching online learning
        </div>
        % endif
        <div class="section-title">
          <h3>
            ${_('Instructors')}
          </h3>
          % if len(authoring_organizations) and authoring_organizations[0]['name']:
            <p>${_('from')} ${authoring_organizations[0]['name']} (${authoring_organizations[0]['key']})</p>
          % endif
        </div>
        <div class="section-content">
          % if len(instructors) > 3:
          <div class="all-the-people">
            % for instructor in instructors:
            <div class="instructor-image-wrapper">
              <img alt="" src="${instructor['profile_image_url']}" onerror="onImgError(this);"/>
            </div>
            % endfor
          </div>
          %endif;

          <div class="accordion instructors">
            % if len(instructors) > 3:
            <div class="header">
              <span class="title">See instructor bios</span>
              <svg width="16" height="16" class="status-icon minus" style="display: none;">
                <use xlink:href="#circle-minus"></use>
              </svg>
              <svg width="16" height="16" class="status-icon plus">
                <use xlink:href="#circle-plus"></use>
              </svg>
            </div>
            <div class="body" style="display: none;">
            %else:
            <div class="body">
            %endif;
              <div class="row lg">
                % for instructor in instructors:
                  <%
                    instructor_hash = hash(instructor['given_name'])
                  %>
                  <div class="col-12 col-sm-6 col-md-4 instructor">
                    <div class="profile-wrapper">
                      <div class="profile-image">
                        <img alt="${instructor['given_name']}" src="${instructor['profile_image_url']}" onerror="onImgError(this);"/>
                      </div>
                      <div class="profile-info">
                        <a href="#instructor-details-${instructor_hash}" class="instructor-label">
                          <div class="instructor-name">${instructor['given_name']}</div>
                        </a>
                        % if instructor.get('position'):
                          <div class="instructor-position">${instructor['position']['title']}</div>
                          <div class="instructor-org">${instructor['position']['organization_name']}</div>
                        % endif
                      </div>
                    </div>
                    % if instructor.get('bio'):
                    <div class="instructor-modal">
                        <div class="col col-12 sm-col-12 md-col-6 lg-col-6 xl-col-6">
                            <div class="modal modal-custom" id="instructor-details-${instructor_hash}">
                                <div class="btn-close modal_close"><i class="fa fa-close"></i></div>
                                <div class="modal-body">
                                  <div class="modal-header">
                                    <div>
                                      <img alt="" src="${instructor['profile_image_url']}" onerror="onImgError(this);"/>
                                      <div class="instructor-name">${instructor['given_name']}</div>
                                      <div>
                                        % if instructor.get('position'):

                                          % if instructor['position']['title']:
                                            <span>${instructor['position']['title']}</span>,
                                          % endif
                                          % if instructor['position']['organization_name']:
                                            <span>${instructor['position']['organization_name']}</span>
                                          % endif
                                          
                                        % endif
                                        
                                      </div>
                                    </div>
                                  </div>
                                  <div class="instructor-bio">${HTML(instructor['bio'])}</div>
                                </div>
                              </div>
                          </div>
                    </div>
                    % endif
                  </div>
                % endfor
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  % endif
  <div class="container">
    <%
      corporate_endorsements = program['corporate_endorsements']
    %>
    % if corporate_endorsements:
    <div class="section endorsements">
      <div class="section-title">
        <h3>
          ${_('Program endorsements')}
        </h3>
      </div>
      <div class="section-content">
        <div class="row">
          % for corporate_endorsement in corporate_endorsements:
          <%
            corporate_endorsement_name = corporate_endorsement.get('corporation_name')
            corporate_endorsement_image = corporate_endorsement['image']['src'] if corporate_endorsement.get('image') else ''
            endorsements = corporate_endorsement.get('individual_endorsements')
            endorsement = endorsements[0] if endorsements else {}
            endorsement_quote = endorsement.get('quote')
            endorser = endorsement.get('endorser', {})
            endorser_given_name = endorser.get('given_name') if endorser.get('given_name') else ''
            endorser_family_name = endorser.get('family_name') if endorser.get('family_name') else ''
            endorser_name = (endorser_given_name + ' ' + endorser_family_name).strip()
            endorser_position = endorser.get('position') if endorser.get('position') else {}
            endorser_title = endorser_position.get('title', '')
            endorser_org = endorser_position.get('organization_name') or corporate_endorsement_name
          %>
          <div class="col-md-6">
            <div class="endorsement">
              <svg xmlns="http://www.w3.org/2000/svg" width="46" height="46" viewBox="0 0 46 46" class="quote-icon">
                <g transform="translate(-98 -4153)">
                  <circle cx="23" cy="23" r="23" transform="translate(98 4153)"/>
                  <path d="M8.355,17.352v7.712h7.712V17.352H12.211s0-3.856,3.856-3.856V9.64s-7.712,0-7.712,7.712ZM27.635,13.5V9.64s-7.712,0-7.712,7.712v7.712h7.712V17.352H23.779S23.779,13.5,27.635,13.5Z" transform="translate(102.645 4158.359)"/>
                </g>
              </svg>
              <div class="endorser_name">${endorser_name}</div>   
              <p class="quote">"${endorsement_quote}"</p>
              %if endorser_title or endorser_org:
              <div class="quote-footer">
                %if endorser_title:
                  ${endorser_title},
                %endif
                %if endorser_org:
                  ${endorser_org}
                %endif
              </div>
              %endif
            </div>
          </div>
          %endfor
        </div>
      </div>
    </div>
    %endif
    % if program.get('is_learner_eligible_for_one_click_purchase'):
    <div class="section purchase" id="purchasing">
      <div class="prices-wrapper">
        <div class="prices">
          % if program.get('discount_data') and program['discount_data']['is_discounted']:
          <span aria-label="${_('Discounted Price')}" class="discount">
            ${Text(_('${newPrice}')).format(
              newPrice=full_program_price,
            )}
          </span>
          <del aria-label="${_('Original Price')}" class="original-price">
          ${Text(_('${oldPrice}')).format(
              oldPrice=full_program_price_format.format(program['discount_data']['total_incl_tax_excl_discounts'])
            )}
          </del>
          % else:
          <span>${"${price}".format(price=full_program_price)}</span>
          % endif
        </div>
      </div>
      <div class="main-content">
        <div class="section-title">
          <h3>
            ${_('Enrolling Now')}
          </h3>
        </div>
        <div class="section-content">
          <div class="info">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <use xlink:href="#checkmark"></use>
            </svg>
            ${len(courses)} courses in ${total_hours_of_effort} hours
          </div>
          <a href="#" class="pursue-btn">${_('Pursue the Program')}</a>
        </div>
      </div>
    </div>
    % endif
    % if faqs:
    <div class="section">
      <div class="section-title">
        <h3>
          ${_('FAQs')}
        </h3>
      </div>
      <div class="section-content">
        <div class="accordions-wrapper">
          % for faq in faqs:
            <div class="accordion">
              <div class="header">
                <span class="title">${faq['question']}</span>
                <svg width="14" height="14" class="status-icon">
                  <use xlink:href="#plus"></use>
                </svg>
              </div>
              <div class="body" style="display: none;">
                ${HTML(faq['answer'])}
              </div>
            </div>
          % endfor
        </div>
      </div>
    </div>
    % endif
  </div>
</div>

<script>
  var facts = $('#facts');
  var factsOffsetTop = facts.offset().top;
  var factsHeight = facts.height();

  $(document).scroll(function() {
    var scrollTop = $(window).scrollTop();
    var instructor = $('#instructor');
    var instructorOffsetTop = instructor.offset().top;

    if (factsOffsetTop - scrollTop <= 106 && instructorOffsetTop - scrollTop >= factsHeight + 40 + 106) {
      facts.addClass('fixed');
      facts.removeClass('absolute');
    } else if (instructorOffsetTop - scrollTop < factsHeight + 40 + 106) {
      facts.removeClass('fixed');
      facts.addClass('absolute');
    } else {
      facts.removeClass('fixed');
      facts.removeClass('absolute');
    }
  });
</script>

<%static:require_module_async module_name="js/dateutil_factory" class_name="DateUtilFactory">
    DateUtilFactory.transform(iterationKey=".localized_datetime");
</%static:require_module_async>
